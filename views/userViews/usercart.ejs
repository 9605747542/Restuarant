
<%-include('header')%>

 
<style>
  /* Style for the increment and decrement buttons */
  .input-number-decrement-btn:hover, .input-number-increment-btn:hover {
    opacity: 0.8;
}


.custom-btn-success {
    background-color: #4CAF50; /* Green */
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    cursor: pointer;
}

.custom-btn-success:hover {
    background-color: #45a049; /* Darker Green */
}
.custom-btn-danger {
    background-color: #ff6347; /* Red */
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    cursor: pointer;
}

.custom-btn-danger:hover {
    background-color: #ff483d; /* Darker Red */
}





</style>

</head>
<body>



<header>

<div class="header-area">
<div class="main-header header-sticky">
<div class="container-fluid">
<div class="row menu-wrapper align-items-center justify-content-between">
<div class="header-left d-flex align-items-center">

<div class="logo">
<a href="index.html"><img src="assets/img/logo/logo.png" alt></a>
</div>

<div class="logo2">
<a href="index.html"><img src="assets/img/logo/logo2.png" alt></a>
</div>

<div class="main-menu  d-none d-lg-block">


<div class="col-12">
<div class="mobile_menu d-block d-lg-none"></div>
</div>
</div>
</div>
</div>
</div>

</header>
<main>

<div class="slider-area ">
<div class="slider-active">
<div class="single-slider hero-overly2  slider-height2 d-flex align-items-center slider-bg2">
<div class="container">
<div class="row">
<div class="col-xl-6 col-lg-8 col-md-8">
<div class="hero__caption hero__caption2">
<h1 data-animation="fadeInUp" data-delay=".4s">Cart List</h1>
<nav aria-label="breadcrumb">
<ol class="breadcrumb">
<li class="breadcrumb-item"><a href="index.html">Home</a></li>
<li class="breadcrumb-item"><a href="#">Cart List</a></li>
</ol>
</nav>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<% if(message) { %>
        <section class="cart_area section-padding40">
            <div class="container">
                <div class="cart_inner">
                    <div class="table-responsive">
                        <table class="table" id="cartTable">
                            <thead>
                                <tr><th><%= message %></th></tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </section>

<%} else{%>
<section class="cart_area section-padding40">
<div class="container">
<div class="cart_inner">
<div class="table-responsive">
<table class="table" id="cartTable">
<thead>
<tr>
<th scope="col">Product</th>
<th scope="col">Price</th>
<th scope="col">Quantity</th>
<th scope="col">Total</th>
<th scope="col">Actions</th>
</tr>
</thead>
<tbody>
  <%for(let i=0;i< datas.length;i++){%>
<tr class="product" data-id="<%= datas[i]._id %>">
  

  
<td>

<div class="media">
<div class="d-flex">
<img style="transition: 10ms;" src="<%=datas[i].image[0]%>" alt="">
</div>
<div class="media-body">
<p><%=datas[i].productName%></p>
 <p><%=datas[i].stock%></p>
</div>
</div>
</td>
<td>
<h5> $<span id="price<%=datas[i]._id%>"><%=datas[i].price%></span></h5>
</td>
<td>
    <div class="product_count" style="display: flex; align-items: center; gap: 5px;">
        <button class="input-number-decrement-btn" onclick="changeQuantity('<%= datas[i]._id %>', -1)" style="background-color: #ff4d4d; color: white; border: none; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 5px;" id="decrement<%= datas[i]._id %>">-</button>
        
        <input  id="quantity<%=datas[i]._id%>" type="text" value="<%=datas[i].quantity%>" min="1" max="10" style="width: 50px; height: 30px; text-align: center; font-size: 14px; border: 1px solid #ccc; border-radius: 5px;">

    
        <button class="input-number-increment-btn" onclick="changeQuantity('<%= datas[i]._id %>', 1)" style="background-color: #4CAF50; color: white; border: none; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 5px;" id="increment<%= datas[i]._id %>">+</button>
    </div>
    
  
    

</td>
<td>

<h5> $<span id="subtotal<%=datas[i]._id%>">0</span></h5>
</td>
<td>
  <button class="btn w-10 " onclick="removeItem('<%= datas[i]._id %>')" data-animation="fadeInUp" >Remove</button>
  </td>


</tr>
<%}%>

<tr>
<td></td>
<td></td>
<td>
<h5>Total</h5>
</td>
<td>
<h5 class="subtotal"> $<span id="total">0</span></h5>
</td>
</tr>

</tbody>
</table>
<div class="checkout_btn_inner float-right">
<a class="btn" href="/getuserproduct">Continue Shopping</a>
<button class="btn checkout_btn" id="proceed-btn" style="color: white;">Proceed to checkout</button>
</div>
</div>
</div>
</div>
<%}%>
</section>


<div class="categories-area section-padding40 gray-bg">
<div class="container">
<div class="row">
<div class="col-lg-3 col-md-6 col-sm-6">
<div class="single-cat mb-50 wow fadeInUp" data-wow-duration="1s" data-wow-delay=".2s">
<div class="cat-icon">
<img src="assets/img/icon/services1.svg" alt>
</div>
<div class="cat-cap">
<h5>Fast & Free Delivery</h5>
<p>Free delivery on all orders</p>
</div>
</div>
</div>
<div class="col-lg-3 col-md-6 col-sm-6">
<div class="single-cat mb-50 wow fadeInUp" data-wow-duration="1s" data-wow-delay=".2s">
<div class="cat-icon">
<img src="assets/img/icon/services2.svg" alt>
</div>
<div class="cat-cap">
<h5>Secure Payment</h5>
<p>Free delivery on all orders</p>
</div>
</div>
</div>
<div class="col-lg-3 col-md-6 col-sm-6">
<div class="single-cat mb-50 wow fadeInUp" data-wow-duration="1s" data-wow-delay=".4s">
<div class="cat-icon">
<img src="assets/img/icon/services3.svg" alt>
</div>
<div class="cat-cap">
<h5>Money Back Guarantee</h5>
<p>Free delivery on all orders</p>
</div>
</div>
</div>
<div class="col-lg-3 col-md-6 col-sm-6">
<div class="single-cat mb-50 wow fadeInUp" data-wow-duration="1s" data-wow-delay=".5s">
<div class="cat-icon">
<img src="assets/img/icon/services4.svg" alt>
</div>
<div class="cat-cap">
<h5>Online Support</h5>
<p>Free delivery on all orders</p>
</div>
</div>
</div>
</div>
</div>
</div>

</main>
<footer>
<div class="footer-wrapper">

<div class="footer-area footer-padding">
<div class="container ">
<div class="row justify-content-between">
<div class="col-xl-4 col-lg-3 col-md-8 col-sm-8">
<div class="single-footer-caption mb-50">
<div class="single-footer-caption mb-30">

<div class="footer-logo mb-35">
<a href="index.html"><img src="assets/img/logo/logo2_footer.png" alt></a>
</div>
<div class="footer-tittle">
<div class="footer-pera">
<p>Suspendisse varius enim in eros elementum tristique. Duis cursus, mi quis viverra ornare, eros dolor interdum nulla.</p>
</div>
</div>

<div class="footer-social">
<a href="#"><i class="fab fa-twitter"></i></a>
<a href="https://bit.ly/sai4ull"><i class="fab fa-facebook-f"></i></a>
<a href="#"><i class="fab fa-pinterest-p"></i></a>
</div>
</div>
</div>
</div>
<div class="col-xl-2 col-lg-2 col-md-4 col-sm-4">
<div class="single-footer-caption mb-50">
<div class="footer-tittle">
<h4>Quick links</h4>
<ul>
<li><a href="#">Image Licensin</a></li>
<li><a href="#">Style Guide</a></li>
<li><a href="#">Privacy Policy</a></li>
</ul>
</div>
</div>
</div>
<div class="col-xl-2 col-lg-2 col-md-4 col-sm-4">
<div class="single-footer-caption mb-50">
<div class="footer-tittle">
<h4>Shop Category</h4>
<ul>
<li><a href="#">Image Licensin</a></li>
<li><a href="#">Style Guide</a></li>
<li><a href="#">Privacy Policy</a></li>
</ul>
</div>
</div>
</div>
<div class="col-xl-2 col-lg-2 col-md-4 col-sm-4">
<div class="single-footer-caption mb-50">
<div class="footer-tittle">
<h4>Pertners</h4>
<ul>
<li><a href="#">Image Licensin</a></li>
<li><a href="#">Style Guide</a></li>
<li><a href="#">Privacy Policy</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="footer-bottom-area">
<div class="container">
<div class="footer-border">
<div class="row d-flex align-items-center">
<div class="col-xl-12 ">
<div class="footer-copy-right text-center">
<p>
Copyright &copy;<script>document.write(new Date().getFullYear());</script> All rights reserved | This template is made with <i class="fa fa-heart" aria-hidden="true"></i> by <a href="https://colorlib.com" target="_blank">Colorlib</a>
</p>
</div>
</div>
</div>
</div>
</div>
</div>

</div>
</footer>

<div id="back-top">
<a title="Go to Top" href="#"> <i class="fas fa-level-up-alt"></i></a>
</div>
<script>





document.addEventListener('DOMContentLoaded', async function() {
    document.querySelectorAll('.product').forEach(product => {
        console.log("blaaa909");

        let productId = product.querySelector('input[type="text"]').id.replace('quantity', '');
        let quantity = parseInt(document.getElementById('quantity' + productId).value);
        console.log("blaaa");
        updateSubtotal(productId, quantity);
    });

    const proceedButton = document.getElementById('proceed-btn');
    proceedButton.addEventListener('click', async function() {
        Swal.fire({
            title: 'Continue with Checkout',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes continue',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'my-popup'
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                let allSuccess = true;

                const products = document.querySelectorAll('.product');
                for (const product of products) {
                  console.log("product",product);
                    let productId = product.querySelector('input[type="text"]').id.replace('quantity', '');
                    let quantity = parseInt(document.getElementById('quantity' + productId).value);
                    let newQuantity = quantity;  // Assuming you have some logic to determine the new quantity

                    console.log(`Updating quantity for product ${productId} to ${newQuantity}`);

                    try {
                      console.log("link works")
                        const response = await fetch(`/getcheckout?quantity=${newQuantity}&productId=${productId}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log("data in the frontend",data);

                        if (data.success === false) {
                     
                          allSuccess=false;
                          Swal.fire({
            title: "Error",
            text: data.message,
            icon: "error"
          })
                        }else{
                      window.location.href=`/getcheckoutpage`
                        }
                        
                    } catch (error) {
                        allSuccess = false;
                        console.error(`Error updating quantity for product ${productId}:`, error);
                        
                    }
                }

                if (allSuccess) {
                    console.log("All quantities updated successfully.");
                    // Proceed with further actions, e.g., redirecting to the checkout page
                } else {
                    console.error("Failed to update quantities for some products.");
                    // Handle the failure case
                }
            }
        });
    });
});
    




 async function changeQuantity(productId, change) {
    console.log(productId);
    console.log("fff",change);
    let quantityInput = document.getElementById('quantity' + productId);
    console.log("vhbjbjbj",quantityInput.value);
    let newQuantity = parseInt(quantityInput.value) + change ;
    console.log("new",newQuantity);
   let total = document.getElementById('subtotal'+productId).innerText;
   console.log(total);
    
 
        
       
        const response= await fetch('/changequantity',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify( {quantity:newQuantity,productId:productId})

        })
        const data= await response.json();
       
        console.log("data from backend",data.success);
        if(data.success===true){
              
            console.log("Quantity updated successfully");
            quantityInput.value=newQuantity;
            console.log("bvnvjbjbu",quantityInput.value);
            updateSubtotal(productId, newQuantity);
        }else{
          swal.fire({
            title: "Error",
            text: data.message,
            icon: "error"
          });
         
            
        }



         
    
}

 async function updateSubtotal(productId, quantity) {
    console.log("hello");
    let price = parseFloat(document.getElementById('price' + productId).innerText);
    let subtotal = quantity * price;
    console.log();
    document.getElementById('subtotal' + productId).innerText = subtotal.toFixed(2);
  const formData={
    subtotal:subtotal,
    proId:productId,
  }

    const response= await fetch('/changetotal',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(formData)

        })
        const data= await response.json();
        console.log("data from backend",data);
        if(data.success===true){
            console.log("subtotal updated successfully");
            updateTotal(); 
        }else{
            console.log("error");
            
        }



   
    }



function updateTotal() {
    let total = 0;
    document.querySelectorAll('.product').forEach(product => {
        let subtotalText = product.querySelector('[id^="subtotal"]').innerText;
        let subtotal = parseFloat(subtotalText);
        total += subtotal;
    });
    console.log("Total amount",total);
    document.getElementById('total').innerText = total.toFixed(2);
}


//for remove cart item
function removeItem(itemId) {
  const row = document.querySelector(`tr[data-id="${itemId}"]`);
  const swalWithBootstrapButtons = Swal.mixin({
  customClass: {
    confirmButton: 'custom-btn-success',
    cancelButton: 'custom-btn-danger'
  },
  buttonsStyling: false
});
swalWithBootstrapButtons.fire({
  title: "Are you sure?",
  text: "You won't be able to revert this!",
  icon: "warning",
  showCancelButton: true,
  confirmButtonText: "Yes, delete it!",
  cancelButtonText: "No, cancel!",
  reverseButtons: true
}).then((result) => {
  if (result.isConfirmed) {
    swalWithBootstrapButtons.fire({
      title: "Deleted!",
      text: "Your file has been deleted.",
      icon: "success"
    });
    fetch(`/removeitemfromcart/${itemId}`, {
        method: 'DELETE',
      })
      .then(response => {
        if (response.ok) {
          // Remove the row from the table
          row.remove();
          updateTotal();

        } else {
          console.error('Failed to remove item from cart');
        }
      })
      .catch(error => {
        console.error('Error removing item from cart:', error);
      });
  } else if (
    /* Read more about handling dismissals below */
    result.dismiss === Swal.DismissReason.cancel
  ) {
    swalWithBootstrapButtons.fire({
      title: "Cancelled",
      text: "Your imaginary file is safe :)",
      icon: "error"
    });
  }
});
}

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="./assets/js/vendor/modernizr-3.5.0.min.js"></script>
<script src="./assets/js/vendor/jquery-1.12.4.min.js"></script>
<script src="./assets/js/popper.min.js"></script>
<script src="./assets/js/bootstrap.min.js"></script>

<script src="./assets/js/owl.carousel.min.js"></script>
<script src="./assets/js/slick.min.js"></script>
<script src="./assets/js/jquery.slicknav.min.js"></script>

<script src="./assets/js/wow.min.js"></script>
<script src="./assets/js/animated.headline.js"></script>
<script src="./assets/js/jquery.magnific-popup.js"></script>
<script src="./assets/js/gijgo.min.js"></script>

<script src="./assets/js/jquery.nice-select.min.js"></script>
<script src="./assets/js/jquery.sticky.js"></script>
<script src="./assets/js/jquery.barfiller.js"></script>

<script src="./assets/js/jquery.counterup.min.js"></script>
<script src="./assets/js/waypoints.min.js"></script>
<script src="./assets/js/jquery.countdown.min.js"></script>
<script src="./assets/js/hover-direction-snake.min.js"></script>

<script src="./assets/js/contact.js"></script>
<script src="./assets/js/jquery.form.js"></script>
<script src="./assets/js/jquery.validate.min.js"></script>
<script src="./assets/js/mail-script.js"></script>
<script src="./assets/js/jquery.ajaxchimp.min.js"></script>

<script src="./assets/js/plugins.js"></script>
<script src="./assets/js/main.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-23581568-13');
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/v84a3a4012de94ce1a686ba8c167c359c1696973893317" integrity="sha512-euoFGowhlaLqXsPWQ48qSkBSCFs3DPRyiwVu3FjR96cMPx+Fr+gpWRhIafcHwqwCqWS42RZhIudOvEI+Ckf6MA==" data-cf-beacon='{"rayId":"85441fb34ad929f3","b":1,"version":"2024.2.0","token":"cd0b4b3a733644fc843ef0b185f98241"}' crossorigin="anonymous"></script>
</body>
</html>